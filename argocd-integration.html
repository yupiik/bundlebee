<!DOCTYPE html>
<html lang="en">

<head>
    <title>ArgoCD integration</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A light Java Kubernetes package manager.">
    <meta name="author" content="Yupiik Minisite Generator">
    <meta name="generator" content="Yupiik Minisite Generator">
    
    <link rel="shortcut icon" href="//www.yupiik.io/bundlebee/images/logo.svg">

    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,700,700i|Montserrat:300,400,500,700" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/asciidoctor.js/1.5.5-5/css/asciidoctor.min.css" integrity="sha512-kI7tn5cuEg16kMeXnYmg8rEJPxbxzEM7Gsr191iQdLDevFBLXPCSU9aZWSVuP61tMZWU3nBAR1cJ7SmXnOGLZw==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css" integrity="sha512-oc9+XSs1H243/FRN9Rw62Fn8EtxjEYWHXRvjS43YtueEewbS6ObfXcJNyohjHqVKFPoXXUxwc+q1K7Dee6vv9g==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/vs2015.min.css" integrity="sha512-w8aclkBlN3Ha08SMwFKXFJqhSUx2qlvTBFLLelF8sm4xQnlg64qmGB/A6pBIKy0W8Bo51yDMDtQiPLNRq1WMcQ==" crossorigin="anonymous" />
    
    <link id="theme-style" rel="stylesheet" href="//www.yupiik.io/bundlebee/css/theme.css?v=1.0.27-SNAPSHOT">
</head>
<body>
    <header class="header fixed-top">
        <div class="branding docs-branding">
            <div class="container-fluid position-relative py-2">
                <div class="docs-logo-wrapper">
	                <div class="site-logo"><a title="Home" class="navbar-brand" href="//www.yupiik.io/bundlebee/index.html">
	                <img class="logo-icon mr-2" src="//www.yupiik.io/bundlebee/images/logo.svg" alt="logo">
	                <span class="logo-text">Yupiik BundleBee <span class="text-alt">Docs</span></span></a></div>
                </div>
	            <div class="docs-top-utilities d-flex justify-content-end align-items-center">
					
					<li class="list-inline-item"><a title="Search" id="search-button" href="#" data-toggle="modal" data-target="#searchModal"><i data-toggle="tooltip" data-placement="top" title="Search" class="fas fa-search"></i></a></li>

					<ul class="social-list list-inline mx-md-3 mx-lg-5 mb-0 d-none d-lg-flex">
						
						<li class="list-inline-item"><a title="Github" href="https://www.github.com/yupiik/"><i class="fab fa-github fa-fw"></i></a></li><li class="list-inline-item"><a title="LinkedIn" href="https://www.linkedin.com/company/yupiik/"><i class="fab fa-linkedin fa-fw"></i></a></li>
		            </ul>
	            </div>
            </div>
        </div>
    </header>
	<div class="page">
        <div class="page-navigation-left">
            <h3>Menu</h3>
            <ul>
                <li>
                    <a title="Getting Started" href="//www.yupiik.io/bundlebee/getting-started.html">
                        <i class="fas fa-play"></i>Getting Started
                    </a>
                </li>                <li>
                    <a title="How it works" href="//www.yupiik.io/bundlebee/how-it-works.html">
                        <i class="fas fa-car-battery"></i>How it works
                    </a>
                </li>                <li>
                    <a title="Available commands" href="//www.yupiik.io/bundlebee/commands.html">
                        <i class="fas fa-terminal"></i>Commands
                    </a>
                </li>                <li>
                    <a title="Available Alveoli" href="//www.yupiik.io/bundlebee/alveoli.html">
                        <i class="fas fa-puzzle-piece"></i>Alveoli
                    </a>
                </li>                <li>
                    <a title="BundleBee Maven Plugin" href="//www.yupiik.io/bundlebee/maven-plugin.html">
                        <i class="fas fa-building"></i>Maven Plugin
                    </a>
                </li>
            </ul>
        </div>

        <div id="argocd-integration-html-container" class="container page-content argocd-integration-html">
                        <div class="page-header">
                <h1>ArgoCD integration</h1>
            </div>
            <div class="page-content-body">
                <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Use the following steps to integrate ArgoCD with BundleBee.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
this page assumes you are already familiar with ArgoCD, if it is not the case refer to ArgoCD documentation please.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_define_bundlebee_as_a_plugin">Define BundleBee as a plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal is to be able to identify a repository with a <code>manifest.json</code> as a BundleBee repository and use BundleBee to convert the repository to JSON files ArgoCD will deploy as descriptors.</p>
</div>
<div class="paragraph">
<p>The steps to integrate with bundlebee are the following ones:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a <code>ConfigManagementPlugin</code>,</p>
</li>
<li>
<p>Configure your application to scan for <code>manifest.json</code>.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_create_the_bundlebee_configmanagementplugin">Create the BundleBee ConfigManagementPlugin</h3>
<div class="paragraph">
<p>First define this descriptor:</p>
</div>
<div class="listingblock">
<div class="title">bundlebee.argocd-plugin.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: ConfigManagementPlugin
metadata:
  name: bundlebee-plugin
spec:
  version: v1.0
  init:
    # if you use any kind of secret management, it can be neat to run a command there to decipher the secrets and prepare generate command
    command: [sh]
    args: [-c, 'echo "BundleBee plugin"']
  generate:
    command: [ "/opt/yupiik/bundlebee/bin/bundlebee.sh" ]
  discover:
    find:
      glob: "**/bundlebee/manifest.json"
  parameters:
    dynamic:
      command: [ "/opt/yupiik/bundlebee/bin/bundlebee.placeholders.sh" ]
    preserveFileMode: false</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
this is NOT a Kubernetes descriptor so don&#8217;t install it wit <code>kubectl</code> or BundleBee. Also note that the command used there only work for BundleBee &gt;= 1.0.25, for versions before use <code>process</code> command to dump the descriptors and then a small script to cat them for ArgoCD.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now create a plugin docker image:</p>
</div>
<div class="listingblock">
<div class="title">Dockerfile</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-Dockerfile hljs" data-lang="Dockerfile">FROM ossyupiik/java:17.0.9.1
RUN mkdir -p /opt/yupiik/bundlebee/lib /opt/yupiik/bundlebee/bin &amp;&amp; \
    wget https://repo.maven.apache.org/maven2/io/yupiik/bundlebee-core/1.0.24/bundlebee-core-1.0.24-fat.jar -O /opt/yupiik/bundlebee/lib/bundlebee.jar <b class="conum">(1)</b>
COPY ./bundlebee.argocd-plugin.yaml /home/argocd/cmp-server/config/plugin.yaml <b class="conum">(2)</b>
COPY ./bundlebee.plugin.sh /opt/yupiik/bundlebee/bin/bundlebee.sh
RUN chmod +x /opt/yupiik/bundlebee/bin/*.sh &amp;&amp; chown 999:0 -R /opt/yupiik/
USER 999
ENTRYPOINT ["/opt/yupiik/bundlebee/bin/bundlebee.sh"]</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ensure to adjust the version you want to use at your needs,</p>
</li>
<li>
<p>Ensure to add the plugin configuration we just created locally in previous step (target location is required by the entry point).</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
you can also use the native version of BundleBee but this requires some more knowledge about the Java native dependencies (<code>apk add --no-cache zlib libstdc++ gcompat</code> for alpine for example).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The launching script will be something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#! /bin/sh

java -Dio.yupiik.bundlebee.level=WARNING -jar \
    /opt/yupiik/bundlebee/lib/bundlebee.jar process \
    --injectTimestamp false --injectBundleBeeMetadata false \
    --output stdout \
    --bundlebee-kube-namespace "${ARGOCD_APP_NAMESPACE}" \
    --from "$ARGOCD_APP_SOURCE_PATH" --manifest "${ARGOCD_APP_SOURCE_PATH}/bundlebee/manifest.json" --alveolus "$ARGOCD_APP_NAME"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the discovery script will be something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#! /bin/sh

java -Dio.yupiik.bundlebee.level=WARNING -jar \
    /opt/yupiik/bundlebee/lib/bundlebee.jar placeholder-extract \
    --outputType ARGOCD \
    --bundlebee-kube-namespace "${ARGOCD_APP_NAMESPACE}" \
    --from "$ARGOCD_APP_SOURCE_PATH" --manifest "${ARGOCD_APP_SOURCE_PATH}/bundlebee/manifest.json" --alveolus "$ARGOCD_APP_NAME"</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
the placeholder discovery and descriptor templating assume ArgoCD application name matches the alveolus name, you can modify the script to make it more resilient.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then build the image: <code>docker build -t yupiik/argocd-bundlebee-plugin:latest .</code>.</p>
</div>
<div class="paragraph">
<p>Now we need to add this configuration into a sidecar of ArgoCD (CMP server).
To do that, edit <code>argocd-repo-server</code> descriptor (we explain how to do it manually but you can do it with BundleBee): <code>kubectl edit deploy -n argocd argocd-repo-server</code>.</p>
</div>
<div class="paragraph">
<p>Add the plugin container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">containers:
... <b class="conum">(1)</b>
- name: bundlebee-plugin
  command: [/var/run/argocd/argocd-cmp-server]
  image: yupiik/argocd-bundlebee-plugin:latest <b class="conum">(2)</b>
  # if you build the image in minikube directly uncomment next line
  # imagePullPolicy: IfNotPresent
  securityContext:
    runAsNonRoot: true
    runAsUser: 999
  volumeMounts:
    - mountPath: /var/run/argocd
      name: var-files
    - mountPath: /home/argocd/cmp-server/plugins
      name: plugins</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Keep default container(s),</p>
</li>
<li>
<p>Set the image you just built.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_limitations">Limitations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The limitations of the integration is that BundleBee does not deploy any more, it is just used as a templating engine (similarly to helm integration) so ArgoCD is the deployer.
The drawback of that option is you loose the deployment options (like forcing <code>PUT</code> to force to override a resource, the control of the merge strategy when you install a resource or the awaiting logic which is different).</p>
</div>
<div class="paragraph">
<p>Please also note that ArgoCD:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Is a runtime so you must ensure it is</p>
<div class="ulist">
<ul>
<li>
<p>up and running,</p>
</li>
<li>
<p>has enough allocated resources (including to redeploy a new version if you use rollout),</p>
</li>
<li>
<p>monitored for upgrades when needed (security + features),</p>
</li>
<li>
<p>has enough storage for its usage (avoid a disk full for ex),</p>
</li>
<li>
<p>has a correct monitoring to ensure you don&#8217;t get into infra troubles if you host it on premise.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Does not come with a solution for secrets (and passwords/keys management) so you still need an option for that,</p>
</li>
<li>
<p>Does use a custom RBAC model for security which is not always trivial to set up.</p>
</li>
<li>
<p>As any software is a new thing to learn for your ops team and can compete with the idea of CI/CD (which has its own RBAC model for example),</p>
</li>
<li>
<p>Since it will store your clusters client configuration, the cluster ArgoCD is installed on must have very secured secrets (don&#8217;t use a weaky-leaky dev environment for example),</p>
</li>
<li>
<p>Similarly to the cluster, if you use some ciphering solution, ensure its storage is very well secured (can go through Kubernetes secrets if you have a specific backend - ie not the default one).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is why at Yupiik we tend to not use ArgoCD but prefer a plain CI/CD pipeline which is offline (does not need a constant runtime resource allocation nor infra monitoring and is self-resilient since you just need <code>git</code> to restore an application).
Most of the time we couple it with BundleBee <code>diff</code> command to ensure if the cluster is synchronized or not with the <code>git</code> state.
We combine it with a ciphering to save password/keys in <code>git</code>, depending the project it can be a Vault, keypass or just our <code>(de)crypt</code> maven <a href="https://www.yupiik.io/tools-maven-plugin/mojos.html#_crypt_mojos">goal</a> which uses a master password for that task (similarly you can use <code>{{bundlebee-decipher:$masterKeyPlaceholder,$cipheredValue}}</code> placeholders, see more on <a href="how-it-works.html">how it works</a> page).
Finally, combine with <a href="https://www.yupiik.io/tools-maven-plugin/mojos.html#_minisite">minisite</a> generator we get live documentation reporting (including potential placeholders) which makes the solution complete.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
it is highly recommended to work on these points before adopting ArgoCD (using BundleBee or not indeed) and to evaluate the plain CI/CD option - including installing a light CI/CD like Harness/Drone which is simpler to setup.
</td>
</tr>
</table>
</div>
</div>
</div>
                
                
            </div>
        </div>
    <div class="page-navigation-right">
        <h3>Navigation</h3>
        <nav class="generated-nav-menu"></nav>
    </div>
    </div>
    <footer class="footer pb-5">
	    <div class="text-center">
		    <ul class="social-list list-unstyled">
                <li class="list-inline-item"><a title="Github" href="https://www.github.com/yupiik/"><i class="fab fa-github fa-fw"></i></a></li><li class="list-inline-item"><a title="LinkedIn" href="https://www.linkedin.com/company/yupiik/"><i class="fab fa-linkedin fa-fw"></i></a></li>
	        </ul>
            <small class="copyright">Yupiik &copy;</small> | <a href="https://www.yupiik.com/terms-of-use/">Terms of use</a> | <a href="https://www.yupiik.com/privacy-policy/">Privacy policy</a>
	    </div>
    </footer>

    <div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="searchModalLabel">Search</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form onsubmit="return false;" class="form-inline">
          <div class="form-group">
            <label for="searchInput"><b>Search: </b></label>
            <input class="form-control" id="searchInput" placeholder="Enter search text and hit enter...">
          </div>
        </form>
        <div class="search-hits"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" ></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.min.js" integrity="sha512-8qmis31OQi6hIRgvkht0s6mCOittjMa9GMqtK9hes5iEQBQE/Ca6yGE5FsW36vyipGoWQswBj/QBm2JR086Rkw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/highlight.min.js" integrity="sha512-d00ajEME7cZhepRqSIVsQVGDJBdZlfHyQLNC6tZXYKTG7iwcF8nhlFuppanz8hYgXr8VvlfKh4gLC25ud3c90A==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/bash.min.js" integrity="sha512-Hg0ufGEvn0AuzKMU0psJ1iH238iUN6THh7EI0CfA0n1sd3yu6PYet4SaDMpgzN9L1yQHxfB3yc5ezw3PwolIfA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/bash.min.js" integrity="sha512-Hg0ufGEvn0AuzKMU0psJ1iH238iUN6THh7EI0CfA0n1sd3yu6PYet4SaDMpgzN9L1yQHxfB3yc5ezw3PwolIfA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/json.min.js" integrity="sha512-37sW1XqaJmseHAGNg4N4Y01u6g2do6LZL8tsziiL5CMXGy04Th65OXROw2jeDeXLo5+4Fsx7pmhEJJw77htBFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/dockerfile.min.js" integrity="sha512-eRNl3ty7GOJPBN53nxLgtSSj2rkYj5/W0Vg0MFQBw8xAoILeT6byOogENHHCRRvHil4pKQ/HbgeJ5DOwQK3SJA==" crossorigin="anonymous"></script>
    <script>if (!(window.minisite || {}).skipHighlightJs) { hljs.highlightAll();
function addCopyButtons(clipboard) {
  document.querySelectorAll('pre > code').forEach(function (codeBlock) {
  var button = document.createElement('button');  button.className = 'copy-code-button';  button.type = 'button';  button.innerText = 'Copy';  button.addEventListener('click', function () {   clipboard.writeText(codeBlock.innerText).then(function () {   button.blur();   button.innerText = 'Copied!';   setTimeout(function () { button.innerText = 'Copy'; }, 2000); }, function (error) { button.innerText = 'Error'; });  });  var pre = codeBlock.parentNode;  if (pre.parentNode.classList.contains('highlight')) {   var highlight = pre.parentNode; highlight.parentNode.insertBefore(button, highlight);  } else { pre.parentNode.insertBefore(button, pre); } });}
if (navigator && navigator.clipboard) { addCopyButtons(navigator.clipboard);} else { var script = document.createElement('script'); script.src = '//cdnjs.cloudflare.com/ajax/libs/clipboard-polyfill/2.7.0/clipboard-polyfill.promise.js'; script.integrity = 'sha256-waClS2re9NUbXRsryKoof+F9qc1gjjIhc2eT7ZbIv94='; script.crossOrigin = 'anonymous'; script.onload = function() {addCopyButtons(clipboard);}; document.body.appendChild(script);} }</script>
    <script src="//www.yupiik.io/bundlebee/js/minisite.js?v=1.0.27-SNAPSHOT"></script>
    <script>$('.page-content-body').generatedNavMenu();</script>
    <script>
            document.querySelector('div.site-logo > a').href =
              document.location.pathname.indexOf('/bundlebee') == 0 ? '/bundlebee/index.html' : '/index.html';
            </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.3/fuse.min.js" integrity="sha512-neoBxVNv0UMXjoilAYGxfWrSsW6iAVclx7vQKdPJ9Peet1bM5YQjU0aIB8LtH8iNPa+pAyMZprBBw2ZQ/Q1LjQ==" crossorigin="anonymous"></script>

</body>
</html>
